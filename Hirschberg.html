<!--
University of Freiburg WS 2017/2018
Chair for Bioinformatics
Supervisor: Martin Raden
Author: Alexander Mattheis
-->

<div id="algorithm_description">
    <div class="description">
        <a href="https://dl.acm.org/citation.cfm?doid=360825.360861">Daniel S. Hirschberg</a>
        introduced 1975 (submitted 1974) an approach to compute the longest common subsequence of two strings.
        This approach can be adapted to compute the global alignment of two sequences
        in quadratic time $O(nm)$ and only linear space, instead of quadratic space like in the former
        <a href="https://doi.org/10.1016/0022-2836(70)90057-4">Needleman-Wunsch (1970)</a> algorithm.
        The idea is that the tracebacks you get from a prefix- and a suffix-alignment are congruent
        i.e. the traceback-cells are the same.
        Because of this, a row of the prefix dynamic programming matrix (DPM)
        and the suffix DPM (assuming same coordinate system) can be added to identify a traceback-cell as the minimum.

        <br />
        <br />

        To do the calculation in linear time,
        the minima have to be computed first for the middle row $i = \lfloor n/2 \rfloor$, where $n = |a|$
        and then you have to split the matrix sequences at the first minimum-position $(i,j)$
        and compute in the resulting upper matrix $DPM(a_1, .., a_i | b_1, .., b_j)$
        and in the resulting lower matrix $DPM(a_{i+1}, .., a_n | b_{j+1}, .., b_m)$ the minima in its middle rows again,
        where $m = |b|$ and $a, \, b$ are sequences. <br />
        This splitting has to be done recursively until $n \leq 1$ or $m = 0$.
        The algorithm works always only with two rows of the DPM
        and reuse the last computed row, to calculate the next row
        until the middle row is computed with the suffix and the prefix approach.
        These two middle rows (one from prefix alignment and one from suffix alignment)
        are then added together and thereby the traceback-cells become identifiable
        as the minima. Important at this point is that the lower and upper matrices
        rows have to be recalculated for the given, cutted input sequences of $a$ and $b$, because Hirschberg
        does not store the full matrix.

        <br />
        <br />

        Our implementation only stores the most left traceback-cell in the row to use less space,
        but the path is nevertheless reconstructable. The last row minimum is computed separately
        from this recursive approach.
        For the given input, the
        <ul>
            <li>recursions</li>
            <li>computed tracecell matrix</li>
            <li>final alignment and traceback</li>
        </ul>
        are simulated with the help of the
        <a href="http://rna.informatik.uni-freiburg.de/Teaching/index.jsp?toolName=Needleman-Wunsch">Needleman-Wunsch</a>
        algorithm and represented reversed order below. <br />
    </div>

    <div class="picture">
        <img src="Hirschberg-120x90.png" />
    </div>
</div>

<h1>Input:</h1>
<div id="algorithm_input">
	<div class="row">
		<div class="colW100"><label>Sequence $a$:</label></div>
		<div class="colW400"><input class="sequence" data-bind="value: input.sequence1" id="sequence_1" placeholder="EXAMPLE 'ATC'"
                                    title="Allowed are A-Z and '-'." type="text"></div>
	</div>

	<div class="row">
		<div class="colW100"><label>Sequence $b$:</label></div>
		<div class="colW400"><input class="sequence" data-bind="value: input.sequence2" id="sequence_2" placeholder="EXAMPLE 'AGTC'"
                                    title="Allowed are A-Z and '-'." type="text"></div>
	</div>

	<div class="row">
		<div class="colW100"><label>Scoring in $s$:</label></div>

		<div class="colW400">
			<span class="group"> <!-- Microsoft Browsers will fallback on text-fields using following input type -->
				Match <input class="fx_parameter" data-bind="value: input.match" id="match" type="number">
				Mismatch <input class="fx_parameter" data-bind="value: input.mismatch" id="mismatch" type="number">
				Gap <input class="fx_parameter" data-bind="value: input.gap" id="gap" type="number">
			</span>

			 <div class="group_hint">
				<b>Hint:</b> <br />
				For distance minimization, <br /> match scores should be negative and all other scores higher.
			</div>
		</div>
	</div>
</div>

<h1>Output</h1>
<div id="algorithm_output">
    <div class="output">
        <div class="main_output">
            <table class="calculation trace_table">
                <thead>
                    <tr>
                        <th><small><b>Trace</b></small></th>
                        <th></th>
                        <!-- ko foreach: input.sequence2 -->
                            <th data-bind="drawChar: [$data, $index()+1]"></th>
                        <!-- /ko -->
                    </tr>
                </thead>

                <tbody>
                    <!-- ko foreach: $root.output.forwardMatrices()[0] --> <!-- to get i-indexes = $parentContext.$index() -->
                        <tr>
                            <!-- ko if: $index() == 0 -->
                                <th></th>
                            <!-- /ko -->

                            <!-- ko if: $index() > 0 -->
                                <th data-bind="drawChar: [$root.input.sequence1()[$index()-1], $index()]"></th>
                            <!-- /ko -->

                            <!-- ko foreach: $root.output.forwardMatrices()[0][0] --> <!-- to get j-indexes = $index() -->
                                <td class="entry">o</td>
                            <!-- /ko -->
                        </tr>
                    <!-- /ko -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="outcome">
        <div class ="ancillary_output">
            <table class="results_header">
                <thead>
					<tr>
						<th>
							Result <br />
                            <small>
                                The result for which the traceback was computed is marked blue.
                            </small>
						</th>
					</tr>
                </thead>
            </table>

            <div class="results_with_scrollbar">
                <table class="results">
                    <tbody>
                        <!-- ko foreach: $root.output.alignments -->
                            <tr>
                                <td class="entry entry_start selected">
                                    <code data-bind="text: $data[0]"></code> <br />
                                    <code data-bind="text: $data[1]"></code> <br />
                                    <code data-bind="text: $data[2]"></code>
                                </td>
                            </tr>
                        <!-- /ko -->
                    </tbody>
                </table>
            </div>

            <table class="results_footer">
                <tr>
                    <th>
                        <small>
                            <b>Hint:</b> Only one traceback computed.
                        </small>
                    </th>
                </tr>
            </table>
        </div>
    </div>

    <h2>Computed Tracecells</h2>
    <div class="output">
        <div class="main_output">
            <table class="calculation tracecells_table">
                <thead>
                    <tr>
                        <th><small><b>Trace-<br />cells</b></small></th>
                        <th></th>
                        <!-- ko foreach: input.sequence2 -->
                            <th data-bind="drawChar: [$data, $index()+1]"></th>
                        <!-- /ko -->
                    </tr>
                </thead>

                <tbody>
                    <!-- ko foreach: $root.output.forwardMatrices()[0] --> <!-- to get i-indexes = $parentContext.$index() -->
                        <tr>
                            <!-- ko if: $index() == 0 -->
                                <th></th>
                            <!-- /ko -->

                            <!-- ko if: $index() > 0 -->
                                <th data-bind="drawChar: [$root.input.sequence1()[$index()-1], $index()]"></th>
                            <!-- /ko -->

                            <!-- ko foreach: $root.output.forwardMatrices()[0][0] --> <!-- to get j-indexes = $index() -->
                                <td class="entry">o</td>
                            <!-- /ko -->
                        </tr>
                    <!-- /ko -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="outcome">
        <div class ="ancillary_output">
            <table class="results_header">
                <thead>
                    <tr>
                        <th>
                            Minima <br />
                            <small>
                                The computed minima are marked blue.
                            </small>
                        </th>
                    </tr>
                </thead>
            </table>

            <div class="results_with_scrollbar">
                <table class="results">
                    <tbody>
                        <tr>
                            <td class="entry entry_start more_left selected">
                                <code data-bind="text: $root.output.globalMinima()"></code>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <table class="results_footer">
                <tr>
                    <th>
                        <small>
                            <b>Hint:</b> In computation-order.
                        </small>
                    </th>
                </tr>
            </table>
        </div>
    </div>

    <h2>Recursions <!-- ko foreach: $data --><span data-bind="text: $data"></span>.<!-- /ko --></h2>
        <a href="#" data-bind="click: $root.output.toggleVisibility, text: $root.output.toggleLinkText"></a>

        <!-- ko foreach: $root.output.recursionNumbersContainer -->
            <div class="recursion">
                <h3>Split <!-- ko foreach: $data --><span data-bind="text: $data"></span>.<!-- /ko --></h3>
                <span class="trace_function" data-bind="text: $root.output.traceFunctions()[$index()]"></span> <br />

                <div class="matrices" data-bind="visible: $root.output.showMatrices">
                    <h4>Prefix Computation</h4>
                    <!-- ko foreach: $root.output.prefixTwoRowsMatrices()[$index()] -->
                        <div class="main_output extra_large">
                            <table class="calculation">
                                <tbody>
                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.matrixDLatex"></span>
                                        </th>

                                        <th></th>

                                        <!-- ko foreach: $root.output.secondSequences()[$parentContext.$index()] -->
                                            <th>
                                                <span data-bind="text: $data"></span><sub><span
                                                    data-bind="text: $root.output.secondSequencePositions()[$parentContext.$parentContext.$index()][$index()]"></span></sub>
                                            </th>
                                        <!-- /ko -->
                                    </tr>

                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.prefixTwoRowsCharacters()[$parentContext.$index()][$index()][0]"></span><sub><span
                                                data-bind="text: $root.output.prefixTwoRowsCharactersPositions()[$parentContext.$index()][$index()][0]"></span></sub>
                                        </th>

                                        <!-- ko foreach: $data[0] -->
                                            <td class="entry" data-bind="text: $data"></td>
                                        <!-- /ko -->
                                    </tr>

                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.prefixTwoRowsCharacters()[$parentContext.$index()][$index()][1]"></span><sub><span
                                                data-bind="text: $root.output.prefixTwoRowsCharactersPositions()[$parentContext.$index()][$index()][1]"></span></sub>
                                        </th>

                                        <!-- ko if: $index() < $root.output.prefixTwoRowsMatrices()[$parentContext.$index()].length - 1 -->
                                            <!-- ko foreach: $data[1] -->
                                                <td class="entry" data-bind="text: $data"></td>
                                            <!-- /ko -->
                                        <!-- /ko -->

                                        <!-- ko if: $index() >= $root.output.prefixTwoRowsMatrices()[$parentContext.$index()].length - 1 -->
                                            <!-- ko foreach: $data[1] -->
                                                <td class="entry selected_light_blue" data-bind="text: $data"></td>
                                            <!-- /ko -->
                                        <!-- /ko -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    <!-- /ko -->

                    <h4>Suffix Computation</h4>
                    <!-- ko foreach: $root.output.suffixTwoRowsMatrices()[$index()] -->
                        <div class="main_output extra_large">
                            <table class="calculation">
                                <tbody>
                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.matrixDPrimeLatex"></span>
                                        </th>

                                        <th></th>

                                        <!-- ko foreach: $root.output.secondSequences()[$parentContext.$index()] -->
                                            <th>
                                                <span data-bind="text: $data"></span><sub><span
                                                    data-bind="text: $root.output.secondSequencePositions()[$parentContext.$parentContext.$index()][$index()]"></span></sub>
                                            </th>
                                        <!-- /ko -->
                                    </tr>

                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.suffixTwoRowsCharacters()[$parentContext.$index()][$index()][0]"></span><sub><span
                                                data-bind="text: $root.output.suffixTwoRowsCharactersPositions()[$parentContext.$index()][$index()][0]"></span></sub>
                                        </th>

                                        <!-- ko if: $index() < $root.output.suffixTwoRowsMatrices()[$parentContext.$index()].length - 1 -->
                                            <!-- ko foreach: $data[0] -->
                                                <td class="entry" data-bind="text: $data"></td>
                                            <!-- /ko -->
                                        <!-- /ko -->

                                        <!-- ko if: $index() >= $root.output.suffixTwoRowsMatrices()[$parentContext.$index()].length - 1 -->
                                            <!-- ko foreach: $data[0] -->
                                                <td class="entry selected_light_blue" data-bind="text: $data"></td>
                                            <!-- /ko -->
                                        <!-- /ko -->
                                    </tr>

                                    <tr>
                                        <th>
                                            <span data-bind="text: $root.output.suffixTwoRowsCharacters()[$parentContext.$index()][$index()][1]"></span><sub><span
                                                data-bind="text: $root.output.suffixTwoRowsCharactersPositions()[$parentContext.$index()][$index()][1]"></span></sub>
                                        </th>

                                        <!-- ko foreach: $data[1] -->
                                            <td class="entry" data-bind="text: $data"></td>
                                        <!-- /ko -->
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    <!-- /ko -->

                </div>

                 <h4>Addition</h4>
                <div class="output">
                    <div class="main_output extra_large">
                        <table class="calculation">
                            <tbody>
                                <tr>
                                    <th>
                                        <small>
                                            <b>Row:</b> <br />
                                            i = <span data-bind="text: $root.output.currentGlobalRow()[$index()]"></span>
                                        </small>
                                    </th>

                                    <th></th>

                                    <!-- ko foreach: $root.output.secondSequences()[$index()] -->
                                        <th>
                                            <span data-bind="text: $data"></span><sub><span data-bind="text: $root.output.secondSequencePositions()[$parentContext.$index()][$index()]"></span></sub>
                                        </th>
                                    <!-- /ko -->
                                </tr>

                                <tr>
                                    <th><span data-bind="text: $root.output.matrixDLatex"></span></th>
                                    <!-- ko foreach: $root.output.forwardRows()[$index()] -->
                                        <td class="entry" data-bind="text: $data"></td>
                                    <!-- /ko -->
                                </tr>

                                <tr>
                                    <th><span data-bind="text: $root.output.matrixDPrimeLatex"></span></th>
                                    <!-- ko foreach: $root.output.mirroredBackwardRows()[$index()] -->
                                        <td class="entry" data-bind="text: $data"></td>
                                    <!-- /ko -->
                                </tr>

                                <tr class="thick_line">
                                    <th><span data-bind="text: $root.output.sumLatex"></span></th>
                                    <!-- ko foreach: $root.output.addedRows()[$index()] -->
                                        <!-- ko if: $root.output.highlightPositions()[$parentContext.$index()][1] == $index() -->
                                            <td class="selected" data-bind="text: $data"></td>
                                        <!-- /ko -->

                                        <!-- ko if: $root.output.highlightPositions()[$parentContext.$index()][1] != $index() -->
                                            <td class="entry" data-bind="text: $data"></td>
                                        <!-- /ko -->
                                    <!-- /ko -->
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <br />
            <br />
        <!-- /ko -->
</div>
